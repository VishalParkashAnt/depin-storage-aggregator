<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    h1, h2, h3 { font-family: 'Space Grotesk', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    .provider-badge { @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold">DePIN Storage Aggregator</h1>
          <p class="mt-2 text-purple-100">Unified access to decentralized storage networks</p>
        </div>
        <div class="flex items-center space-x-4">
          <a href="/orders" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
            My Orders
          </a>
          <div id="user-info" class="hidden">
            <span id="user-email" class="text-sm"></span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Login Modal -->
  <div id="login-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold mb-4">Get Started</h2>
      <p class="text-gray-600 mb-6">Enter your email to continue with your purchase</p>
      <form id="login-form">
        <input type="email" id="login-email" required 
               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
               placeholder="Enter your email">
        <button type="submit" 
                class="w-full mt-4 bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700 transition">
          Continue
        </button>
      </form>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Filters -->
    <div class="mb-8 flex flex-wrap gap-4 items-center">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Provider</label>
        <select id="provider-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
          <option value="">All Providers</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Storage Size</label>
        <select id="storage-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
          <option value="">Any Size</option>
          <option value="0-10">Up to 10GB</option>
          <option value="10-100">10-100GB</option>
          <option value="100-1000">100GB-1TB</option>
          <option value="1000+">1TB+</option>
        </select>
      </div>
      <div class="ml-auto">
        <span id="plan-count" class="text-gray-500">Loading plans...</span>
      </div>
    </div>

    <!-- Plans Grid -->
    <div id="plans-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Plans will be loaded here -->
      <div class="col-span-full text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
        <p class="mt-4 text-gray-500">Loading storage plans...</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-8 mt-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center">
        <p class="text-gray-400">© 2024 DePIN Storage Aggregator. All testnets.</p>
        <div class="flex space-x-4 text-gray-400 text-sm">
          <span>Filecoin</span>
          <span>•</span>
          <span>Arweave</span>
          <span>•</span>
          <span>Storj</span>
          <span>•</span>
          <span>Greenfield</span>
          <span>•</span>
          <span>Akash</span>
        </div>
      </div>
    </div>
  </footer>

  <script>
    const stripe = Stripe('<%= stripePublishableKey %>');
    let currentUser = null;
    let allPlans = [];

    // Provider colors
    const providerColors = {
      filecoin: 'bg-blue-100 text-blue-800',
      arweave: 'bg-yellow-100 text-yellow-800',
      storj: 'bg-green-100 text-green-800',
      greenfield: 'bg-orange-100 text-orange-800',
      akash: 'bg-red-100 text-red-800',
    };

    // Load user from localStorage
    function loadUser() {
      const user = localStorage.getItem('depin_user');
      if (user) {
        currentUser = JSON.parse(user);
        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('user-email').textContent = currentUser.email;
      }
    }

    // Show login modal
    function showLoginModal(callback) {
      document.getElementById('login-modal').classList.remove('hidden');
      document.getElementById('login-modal').classList.add('flex');
      window.loginCallback = callback;
    }

    // Hide login modal
    function hideLoginModal() {
      document.getElementById('login-modal').classList.add('hidden');
      document.getElementById('login-modal').classList.remove('flex');
    }

    // Login handler
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      
      try {
        const response = await fetch('/api/users/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });
        
        const data = await response.json();
        if (data.success) {
          currentUser = data.data;
          localStorage.setItem('depin_user', JSON.stringify(currentUser));
          document.getElementById('user-info').classList.remove('hidden');
          document.getElementById('user-email').textContent = currentUser.email;
          hideLoginModal();
          if (window.loginCallback) {
            window.loginCallback();
          }
        }
      } catch (error) {
        console.error('Login failed:', error);
        alert('Login failed. Please try again.');
      }
    });

    // Load providers
    async function loadProviders() {
      try {
        const response = await fetch('/api/providers');
        const data = await response.json();
        
        if (data.success) {
          const select = document.getElementById('provider-filter');
          data.data.forEach(provider => {
            const option = document.createElement('option');
            option.value = provider.slug;
            option.textContent = provider.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load providers:', error);
      }
    }

    // Load plans
    async function loadPlans(filters = {}) {
      try {
        let url = '/api/storage/plans?pageSize=50';
        if (filters.provider) url += `&provider=${filters.provider}`;
        if (filters.minStorage) url += `&minStorage=${filters.minStorage}`;
        if (filters.maxStorage) url += `&maxStorage=${filters.maxStorage}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
          allPlans = data.data;
          renderPlans(allPlans);
          document.getElementById('plan-count').textContent = 
            `${data.meta.total} plans available`;
        }
      } catch (error) {
        console.error('Failed to load plans:', error);
        document.getElementById('plans-grid').innerHTML = 
          '<p class="col-span-full text-center text-red-500">Failed to load plans</p>';
      }
    }

    // Render plans
    function renderPlans(plans) {
      const grid = document.getElementById('plans-grid');
      
      if (plans.length === 0) {
        grid.innerHTML = '<p class="col-span-full text-center text-gray-500">No plans found</p>';
        return;
      }
      
      grid.innerHTML = plans.map(plan => `
        <div class="bg-white rounded-xl shadow-md overflow-hidden card-hover transition-all duration-300">
          <div class="p-6">
            <div class="flex justify-between items-start mb-4">
              <span class="provider-badge ${providerColors[plan.providerSlug] || 'bg-gray-100 text-gray-800'}">
                ${plan.providerName}
              </span>
              <span class="text-xs text-gray-400 uppercase">${plan.network}</span>
            </div>
            
            <h3 class="text-xl font-bold text-gray-900 mb-2">${plan.name}</h3>
            <p class="text-gray-500 text-sm mb-4 line-clamp-2">${plan.description || ''}</p>
            
            <div class="space-y-2 mb-4">
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Storage</span>
                <span class="font-medium">${plan.storageSizeGb} GB</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Duration</span>
                <span class="font-medium">${plan.durationDays} days</span>
              </div>
              ${plan.priceNative ? `
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Native Price</span>
                <span class="font-medium">${plan.priceNative} ${plan.nativeCurrency}</span>
              </div>` : ''}
            </div>
            
            <div class="border-t pt-4">
              <div class="flex justify-between items-center mb-4">
                <span class="text-gray-500">Price</span>
                <span class="text-2xl font-bold text-purple-600">$${plan.priceUsd}</span>
              </div>
              
              <button onclick="purchasePlan('${plan.id}')" 
                      class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700 transition">
                Purchase Storage
              </button>
            </div>
          </div>
          
          ${plan.features && plan.features.length > 0 ? `
          <div class="bg-gray-50 px-6 py-4">
            <p class="text-xs font-medium text-gray-500 mb-2">FEATURES</p>
            <ul class="text-xs text-gray-600 space-y-1">
              ${plan.features.slice(0, 3).map(f => `<li>✓ ${f}</li>`).join('')}
              ${plan.features.length > 3 ? `<li class="text-gray-400">+${plan.features.length - 3} more</li>` : ''}
            </ul>
          </div>` : ''}
        </div>
      `).join('');
    }

    // Purchase plan
    async function purchasePlan(planId) {
      if (!currentUser) {
        showLoginModal(() => purchasePlan(planId));
        return;
      }
      
      try {
        const response = await fetch('/api/payments/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: currentUser.id,
            planId: planId,
          }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Redirect to Stripe Checkout
          window.location.href = data.data.sessionUrl;
        } else {
          alert(data.error?.message || 'Failed to create checkout session');
        }
      } catch (error) {
        console.error('Purchase failed:', error);
        alert('Failed to initiate purchase. Please try again.');
      }
    }

    // Filter handlers
    document.getElementById('provider-filter').addEventListener('change', () => {
      const provider = document.getElementById('provider-filter').value;
      const storageRange = document.getElementById('storage-filter').value;
      applyFilters(provider, storageRange);
    });

    document.getElementById('storage-filter').addEventListener('change', () => {
      const provider = document.getElementById('provider-filter').value;
      const storageRange = document.getElementById('storage-filter').value;
      applyFilters(provider, storageRange);
    });

    function applyFilters(provider, storageRange) {
      const filters = {};
      if (provider) filters.provider = provider;
      if (storageRange) {
        if (storageRange === '1000+') {
          filters.minStorage = 1000;
        } else {
          const [min, max] = storageRange.split('-').map(Number);
          if (min) filters.minStorage = min;
          if (max) filters.maxStorage = max;
        }
      }
      loadPlans(filters);
    }

    // Initialize
    loadUser();
    loadProviders();
    loadPlans();
  </script>
</body>
</html>
