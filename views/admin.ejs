<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    h1, h2, h3 { font-family: 'Space Grotesk', sans-serif; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Sidebar -->
  <div class="flex">
    <aside class="w-64 bg-gray-900 min-h-screen p-6">
      <h1 class="text-white text-xl font-bold mb-8">DePIN Admin</h1>
      <nav class="space-y-2">
        <a href="#dashboard" class="flex items-center text-white bg-purple-600 px-4 py-2 rounded-lg">
          <span class="mr-3">üìä</span> Dashboard
        </a>
        <a href="#orders" class="flex items-center text-gray-300 hover:text-white hover:bg-gray-800 px-4 py-2 rounded-lg transition">
          <span class="mr-3">üì¶</span> Orders
        </a>
        <a href="#providers" class="flex items-center text-gray-300 hover:text-white hover:bg-gray-800 px-4 py-2 rounded-lg transition">
          <span class="mr-3">üîó</span> Providers
        </a>
        <a href="#users" class="flex items-center text-gray-300 hover:text-white hover:bg-gray-800 px-4 py-2 rounded-lg transition">
          <span class="mr-3">üë•</span> Users
        </a>
      </nav>
      <div class="mt-auto pt-8">
        <a href="/" class="text-gray-400 hover:text-white text-sm">‚Üê Back to Site</a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-bold text-gray-900">Dashboard</h2>
        <div class="flex space-x-4">
          <button onclick="syncProviders()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
            üîÑ Sync Providers
          </button>
          <button onclick="refreshData()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
            ‚Üª Refresh
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Total Orders</p>
              <p id="stat-total-orders" class="text-3xl font-bold text-gray-900 mt-1">-</p>
            </div>
            <div class="text-4xl">üì¶</div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Completed</p>
              <p id="stat-completed-orders" class="text-3xl font-bold text-green-600 mt-1">-</p>
            </div>
            <div class="text-4xl">‚úÖ</div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Total Revenue</p>
              <p id="stat-revenue" class="text-3xl font-bold text-purple-600 mt-1">-</p>
            </div>
            <div class="text-4xl">üí∞</div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Active Providers</p>
              <p id="stat-providers" class="text-3xl font-bold text-blue-600 mt-1">-</p>
            </div>
            <div class="text-4xl">üîó</div>
          </div>
        </div>
      </div>

      <!-- Provider Stats & Sync Status -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm">
          <div class="p-6 border-b">
            <h3 class="text-lg font-bold">Provider Status</h3>
          </div>
          <div id="provider-list" class="p-6">
            <p class="text-gray-500">Loading providers...</p>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm">
          <div class="p-6 border-b">
            <h3 class="text-lg font-bold">System Health</h3>
          </div>
          <div id="health-status" class="p-6">
            <p class="text-gray-500">Checking system health...</p>
          </div>
        </div>
      </div>

      <!-- Recent Orders -->
      <div class="bg-white rounded-xl shadow-sm">
        <div class="p-6 border-b flex justify-between items-center">
          <h3 class="text-lg font-bold">Recent Orders</h3>
          <a href="#orders" class="text-purple-600 hover:underline text-sm">View All ‚Üí</a>
        </div>
        <div id="recent-orders" class="p-6">
          <p class="text-gray-500">Loading orders...</p>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Load dashboard data
    async function loadDashboard() {
      await Promise.all([
        loadOrderStats(),
        loadProviderStats(),
        loadHealthStatus(),
        loadRecentOrders(),
      ]);
    }

    async function loadOrderStats() {
      try {
        const response = await fetch('/api/orders/stats');
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('stat-total-orders').textContent = data.data.totalOrders;
          document.getElementById('stat-completed-orders').textContent = data.data.completedOrders;
          document.getElementById('stat-revenue').textContent = '$' + (data.data.totalRevenueCents / 100).toFixed(2);
        }
      } catch (error) {
        console.error('Failed to load order stats:', error);
      }
    }

    async function loadProviderStats() {
      try {
        const response = await fetch('/api/providers/stats/overview');
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('stat-providers').textContent = data.data.activeProviders;
        }

        // Also load provider list
        const providersRes = await fetch('/api/providers');
        const providersData = await providersRes.json();
        
        if (providersData.success) {
          const container = document.getElementById('provider-list');
          container.innerHTML = providersData.data.map(p => `
            <div class="flex items-center justify-between py-3 border-b last:border-0">
              <div class="flex items-center">
                <span class="w-2 h-2 rounded-full ${p.status === 'ACTIVE' ? 'bg-green-500' : 'bg-gray-400'} mr-3"></span>
                <span class="font-medium">${p.name}</span>
              </div>
              <div class="flex items-center space-x-4">
                <span class="text-xs text-gray-400">${p.network}</span>
                <button onclick="syncProvider('${p.slug}')" class="text-purple-600 hover:text-purple-800 text-sm">
                  Sync
                </button>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Failed to load provider stats:', error);
      }
    }

    async function loadHealthStatus() {
      try {
        const response = await fetch('/api/health');
        const data = await response.json();
        
        const container = document.getElementById('health-status');
        container.innerHTML = `
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span class="text-gray-600">API Status</span>
              <span class="px-2 py-1 rounded text-xs font-medium ${data.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${data.success ? 'Healthy' : 'Error'}
              </span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-600">Version</span>
              <span class="text-gray-900 font-medium">${data.data?.version || 'Unknown'}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-600">Last Check</span>
              <span class="text-gray-900">${new Date().toLocaleTimeString()}</span>
            </div>
          </div>
        `;
      } catch (error) {
        document.getElementById('health-status').innerHTML = `
          <div class="text-red-500">Failed to check system health</div>
        `;
      }
    }

    async function loadRecentOrders() {
      try {
        const response = await fetch('/api/orders?pageSize=10');
        const data = await response.json();
        
        const container = document.getElementById('recent-orders');
        
        if (!data.success || data.data.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No orders yet</p>';
          return;
        }

        const statusColors = {
          COMPLETED: 'bg-green-100 text-green-800',
          PENDING_PAYMENT: 'bg-yellow-100 text-yellow-800',
          PAYMENT_COMPLETED: 'bg-blue-100 text-blue-800',
          BLOCKCHAIN_PROCESSING: 'bg-blue-100 text-blue-800',
          PAYMENT_FAILED: 'bg-red-100 text-red-800',
          BLOCKCHAIN_FAILED: 'bg-red-100 text-red-800',
          CANCELLED: 'bg-gray-100 text-gray-800',
        };

        container.innerHTML = `
          <table class="w-full">
            <thead class="text-left text-sm text-gray-500">
              <tr>
                <th class="pb-3">Order #</th>
                <th class="pb-3">Provider</th>
                <th class="pb-3">Plan</th>
                <th class="pb-3">Amount</th>
                <th class="pb-3">Status</th>
                <th class="pb-3">Date</th>
              </tr>
            </thead>
            <tbody>
              ${data.data.map(order => `
                <tr class="border-t">
                  <td class="py-3 font-medium">${order.orderNumber}</td>
                  <td class="py-3">${order.provider.name}</td>
                  <td class="py-3">${order.plan.name}</td>
                  <td class="py-3">$${order.priceUsd}</td>
                  <td class="py-3">
                    <span class="px-2 py-1 rounded text-xs font-medium ${statusColors[order.status] || 'bg-gray-100'}">
                      ${order.status.replace(/_/g, ' ')}
                    </span>
                  </td>
                  <td class="py-3 text-gray-500">${new Date(order.createdAt).toLocaleDateString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Failed to load orders:', error);
        document.getElementById('recent-orders').innerHTML = '<p class="text-red-500">Failed to load orders</p>';
      }
    }

    async function syncProviders() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚è≥ Syncing...';
      
      try {
        const response = await fetch('/api/providers/sync', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          alert('Providers synced successfully!');
          loadDashboard();
        } else {
          alert('Sync failed: ' + (data.error?.message || 'Unknown error'));
        }
      } catch (error) {
        alert('Sync failed: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Sync Providers';
      }
    }

    async function syncProvider(slug) {
      try {
        const response = await fetch(`/api/providers/${slug}/sync`, { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          alert(`${slug} synced successfully!`);
          loadProviderStats();
        } else {
          alert('Sync failed');
        }
      } catch (error) {
        alert('Sync failed: ' + error.message);
      }
    }

    function refreshData() {
      loadDashboard();
    }

    // Initialize
    loadDashboard();
    
    // Auto-refresh every 30 seconds
    setInterval(loadDashboard, 30000);
  </script>
</body>
</html>
